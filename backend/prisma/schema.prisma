// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Player {
  id        String   @id @default(uuid())
  name      String
  apiKey    String   @unique @default(cuid())
  gold      Int      @default(1000)
  exp       Int      @default(0)
  level     Int      @default(1)
  
  // 头像和推特
  avatar    String   @default("https://robohash.org/default.png?set=set1")
  twitter   String?  // Optional: 推特账号

  createdAt DateTime @default(now())
  lands     Land[]
 
  // 关注关系
  following Follow[] @relation("Following")  // 我关注的人
  followers Follow[] @relation("Followers")  // 关注我的人
  
  // 偷菜记录
  steals        StealRecord[] @relation("Stealer")
  stolenFrom    StealRecord[] @relation("Victim")
  
  // 通知
  notifications Notification[]
}

model Land {
  id        Int       @id @default(autoincrement())
  position  Int
  // status: empty, planted, harvestable, withered
  status    String    @default("empty") 
  cropType  String?
  plantedAt DateTime?
  matureAt  DateTime?

  // [新增] 惰性计算的核心字段：
  // 记录上一次结算状态的时间。
  // 每次读取（getPlayerState）时，会计算 (now - lastCalculatedAt) 的分钟数，
  // 然后根据概率补算这段时间内是否发生了灾害。
  lastCalculatedAt DateTime @default(now()) 

  player    Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId  String
  
  // 被偷次数
  stolenCount Int     @default(0)

  // 作物状态 (灾害)
  hasWeeds    Boolean @default(false) // 杂草
  hasPests    Boolean @default(false) // 虫害
  needsWater  Boolean @default(false) // 干旱
  
  // 多季作物记录
  remainingHarvests Int @default(1) // 剩余收获次数

  // 索引优化
  @@unique([playerId, position]) // 确保每个位置唯一
  @@index([status])              // 加速查询特定状态的土地
}

model Crop {
  type       String @id
  name       String
  seedPrice  Int
  sellPrice  Int
  matureTime Int    // 秒
  exp        Int
  yield      Int    @default(1)
  
  // 多季作物配置
  maxHarvests Int    @default(1) // 总共可收获几季
  regrowTime  Int    @default(0) // 再生时间 (秒)
}

// 关注关系
model Follow {
  id          Int      @id @default(autoincrement())
  follower    Player   @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  followerId  String   
  following   Player   @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)
  followingId String   
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
}

// 偷菜记录
model StealRecord {
  id        Int      @id @default(autoincrement())
  stealer   Player   @relation("Stealer", fields: [stealerId], references: [id], onDelete: Cascade)
  stealerId String
  victim    Player   @relation("Victim", fields: [victimId], references: [id], onDelete: Cascade)
  victimId  String
  landPos   Int
  cropType  String
  amount    Int      
  goldValue Int      
  createdAt DateTime @default(now())
}

// 通知
model Notification {
  id        Int      @id @default(autoincrement())
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId  String
  type      String   
  message   String
  data      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}