version: '3.8'

services:
  game-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: qq-farm-game
    environment:
      NODE_ENV: production
      SERVICE_NAME: game
      PORT: 3001
      DATABASE_URL: postgresql://farm_user:farm_password_2024@postgres:5432/qq_farm?schema=public
      REDIS_URL: redis://redis:6379
      CLICKHOUSE_HOST: http://clickhouse:8123
    ports:
      - "3001:3001"
    networks:
      - farm-network
    restart: unless-stopped
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: game.logs
        mode: non-blocking
        max-buffer-size: 4m

  worker-sync:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: qq-farm-worker-sync
    environment:
      NODE_ENV: production
      SERVICE_NAME: worker-sync
      HOSTNAME: worker-sync
      DATABASE_URL: postgresql://farm_user:farm_password_2024@postgres:5432/qq_farm?schema=public
      REDIS_URL: redis://redis:6379
    networks:
      - farm-network
    restart: unless-stopped

  worker-logs:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: qq-farm-worker-logs
    environment:
      NODE_ENV: production
      SERVICE_NAME: worker-logs
      HOSTNAME: worker-logs
      DATABASE_URL: postgresql://farm_user:farm_password_2024@postgres:5432/qq_farm?schema=public
      REDIS_URL: redis://redis:6379
      CLICKHOUSE_HOST: http://clickhouse:8123
    networks:
      - farm-network
    restart: unless-stopped

networks:
  farm-network:
    external: true