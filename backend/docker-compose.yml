version: '3.8'

services:
  game-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: qq-farm-game
    environment:
      NODE_ENV: production
      SERVICE_NAME: game
      PORT: 3001
      # 游戏服连接数给多一点
      DATABASE_URL: postgresql://farm_user:farm_password_2024@postgres:5432/qq_farm?schema=public&connection_limit=10
      REDIS_URL: redis://redis:6379
      CLICKHOUSE_HOST: http://clickhouse:8123
    ports:
      - "3001:3001"
    networks:
      - farm-network
    restart: unless-stopped
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:24224
        tag: game.logs
        mode: non-blocking
        max-buffer-size: 4m

  worker-sync:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: qq-farm-worker-sync
    environment:
      NODE_ENV: production
      SERVICE_NAME: worker-sync
      HOSTNAME: worker-sync
      # Worker 连接数少一点
      DATABASE_URL: postgresql://farm_user:farm_password_2024@postgres:5432/qq_farm?schema=public&connection_limit=5
      REDIS_URL: redis://redis:6379
    networks:
      - farm-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  worker-logs:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: qq-farm-worker-logs
    environment:
      NODE_ENV: production
      SERVICE_NAME: worker-logs
      HOSTNAME: worker-logs
      DATABASE_URL: postgresql://farm_user:farm_password_2024@postgres:5432/qq_farm?schema=public&connection_limit=5
      REDIS_URL: redis://redis:6379
      CLICKHOUSE_HOST: http://clickhouse:8123
    networks:
      - farm-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # [新增] 排行榜 Worker
  worker-leaderboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: qq-farm-worker-leaderboard
    environment:
      NODE_ENV: production
      SERVICE_NAME: worker-leaderboard
      HOSTNAME: worker-leaderboard
      # 排行榜主要操作 Redis，DB 连接数可以很小
      DATABASE_URL: postgresql://farm_user:farm_password_2024@postgres:5432/qq_farm?schema=public&connection_limit=3
      REDIS_URL: redis://redis:6379
    networks:
      - farm-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  farm-network:
    external: true